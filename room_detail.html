<script>
    let supabaseClient;
    let currentRoom = null;
    let currentUser = null;
    let messageSubscription = null;

    // Проверка авторизации
    async function checkAuth() {
        const user = localStorage.getItem('currentUser');
        if (!user) {
            window.location.href = 'auth.html';
            return null;
        }
        return JSON.parse(user);
    }

    // Загрузка комнаты
    async function loadRoom() {
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('room');
        
        if (!roomId) {
            window.location.href = 'home.html';
            return;
        }

        try {
            console.log('Загрузка комнаты:', roomId);
            const { data: room, error } = await supabaseClient
                .from('rooms')
                .select(`
                    *,
                    users:creator_id(username)
                `)
                .eq('id', roomId)
                .single();

            if (error || !room) {
                console.error('Комната не найдена:', error);
                window.location.href = 'home.html';
                return;
            }

            currentRoom = room;
            document.getElementById('room-name').textContent = room.name;
            document.getElementById('room-description').textContent = room.description || 'Нет описания';

            // Показываем кнопку удаления только создателю комнаты
            if (room.creator_id === currentUser.id) {
                document.getElementById('delete-room-btn').classList.remove('hidden');
            }

            loadMessages();
            setupRealtimeMessages();

        } catch (error) {
            console.error('Ошибка загрузки комнаты:', error);
        }
    }

    // Загрузка сообщений
    async function loadMessages() {
        try {
            console.log('Загрузка сообщений для комнаты:', currentRoom.id);
            const { data: messages, error } = await supabaseClient
                .from('messages')
                .select(`
                    *,
                    users:user_id(username)
                `)
                .eq('room_id', currentRoom.id)
                .order('created_at', { ascending: true });

            if (error) {
                console.error('Ошибка загрузки сообщений:', error);
                return;
            }

            console.log('Загружено сообщений:', messages);
            displayMessages(messages);
        } catch (error) {
            console.error('Ошибка:', error);
        }
    }

    function displayMessages(messages) {
        const messagesContainer = document.getElementById('chat-messages');
        
        if (!messages || messages.length === 0) {
            messagesContainer.innerHTML = '<div class="message other"><div class="message-content">Пока нет сообщений. Будьте первым!</div></div>';
            return;
        }

        messagesContainer.innerHTML = '';
        messages.forEach(message => {
            addMessageToChat(message, false);
        });
        
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function addMessageToChat(message, scroll = true) {
        const messagesContainer = document.getElementById('chat-messages');
        const messageElement = document.createElement('div');
        
        const isOwnMessage = message.user_id === currentUser.id;
        messageElement.className = `message ${isOwnMessage ? 'own' : 'other'}`;
        
        const time = new Date(message.created_at);
        const timeStr = `${time.getHours().toString().padStart(2, '0')}:${time.getMinutes().toString().padStart(2, '0')}`;
        
        messageElement.innerHTML = `
            <div class="message-header">
                <span class="message-user">${message.users.username}</span>
                <span class="message-time">${timeStr}</span>
            </div>
            <div class="message-content">${message.content}</div>
        `;
        
        messagesContainer.appendChild(messageElement);
        
        if (scroll) {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
    }

    function setupRealtimeMessages() {
        // Отписываемся от предыдущей подписки
        if (messageSubscription) {
            supabaseClient.removeChannel(messageSubscription);
        }

        console.log('Настройка realtime для комнаты:', currentRoom.id);
        
        // Подписываемся на новые сообщения
        messageSubscription = supabaseClient
            .channel('room-messages')
            .on('postgres_changes', 
                { 
                    event: 'INSERT', 
                    schema: 'public', 
                    table: 'messages',
                    filter: `room_id=eq.${currentRoom.id}`
                }, 
                (payload) => {
                    console.log('Новое сообщение:', payload);
                    // Загружаем полные данные сообщения с именем пользователя
                    supabaseClient
                        .from('messages')
                        .select(`
                            *,
                            users:user_id(username)
                        `)
                        .eq('id', payload.new.id)
                        .single()
                        .then(({ data: message }) => {
                            if (message) {
                                addMessageToChat(message);
                            }
                        });
                }
            )
            .subscribe((status) => {
                console.log('Realtime статус:', status);
            });
    }

    async function sendMessage() {
        const messageInput = document.getElementById('message-input');
        const content = messageInput.value.trim();
        
        if (!content) return;

        console.log('Отправка сообщения:', content);

        try {
            const { data, error } = await supabaseClient
                .from('messages')
                .insert([
                    {
                        room_id: currentRoom.id,
                        user_id: currentUser.id,
                        content: content
                    }
                ])
                .select()
                .single();

            if (error) {
                console.error('Ошибка отправки сообщения:', error);
                alert('Ошибка отправки: ' + error.message);
            } else {
                console.log('Сообщение отправлено:', data);
                messageInput.value = '';
            }
        } catch (error) {
            console.error('Ошибка:', error);
            alert('Ошибка: ' + error.message);
        }
    }

    async function deleteRoom() {
        if (!confirm('Вы уверены, что хотите удалить эту комнату? Все сообщения будут удалены.')) return;

        try {
            const { error } = await supabaseClient
                .from('rooms')
                .delete()
                .eq('id', currentRoom.id);

            if (error) {
                alert('Ошибка при удалении комнаты: ' + error.message);
            } else {
                window.location.href = 'home.html';
            }
        } catch (error) {
            console.error('Ошибка:', error);
        }
    }

    // Инициализация
    window.addEventListener('load', async function() {
        console.log('Page loaded, initializing chat...');
        
        // Проверяем библиотеки
        if (typeof window.supabase === 'undefined') {
            console.error('Supabase library not loaded!');
            return;
        }
        
        if (typeof SUPABASE_URL === 'undefined' || typeof SUPABASE_ANON_KEY === 'undefined') {
            console.error('Config not loaded!');
            return;
        }
        
        // Инициализируем Supabase
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log('Supabase инициализирован');
        
        // Проверяем авторизацию
        currentUser = await checkAuth();
        if (currentUser) {
            document.getElementById('username-display').textContent = currentUser.username;
            await loadRoom();
        }
    });

    document.getElementById('send-message').addEventListener('click', sendMessage);
    document.getElementById('message-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    document.getElementById('delete-room-btn').addEventListener('click', deleteRoom);
    document.getElementById('logout-btn').addEventListener('click', function() {
        localStorage.removeItem('currentUser');
        window.location.href = 'index.html';
    });

    // Отписываемся при закрытии страницы
    window.addEventListener('beforeunload', function() {
        if (messageSubscription) {
            supabaseClient.removeChannel(messageSubscription);
        }
    });
</script>
